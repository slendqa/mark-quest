<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mark's Quest Center PRO üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .quest-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .quest-card:active { transform: scale(0.95); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.7rem; font-weight: bold; position: relative; }
        .calendar-day.selected { border: 2px solid #3b82f6; background-color: #eff6ff; }
        .progress-bar { transition: width 1s ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .admin-tab-btn.active { background-color: #1e293b; color: white; }
        #test-report { animation: slideIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes slideIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-2xl mx-auto">
        <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
        <div id="loading" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[300] flex items-center justify-center font-bold text-slate-600 text-center px-4">
            <div><div class="text-4xl mb-4 animate-bounce">üöÄ</div>–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–≤'—è–∑–æ–∫ –∑ –±–∞–∑–æ—é...</div>
        </div>

        <!-- –®–∞–ø–∫–∞ -->
        <header class="bg-white p-6 rounded-3xl shadow-lg border-b-4 border-blue-100 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                <div class="text-center sm:text-left">
                    <h1 id="ui-greeting" class="text-2xl font-extrabold text-slate-800 tracking-tight">–ú–∞—Ä–∫, –≤–ø–µ—Ä–µ–¥! üöÄ</h1>
                    <div class="flex items-center gap-2 mt-1 justify-center sm:justify-start">
                        <span id="user-rank" class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded-full uppercase italic">...</span>
                        <span class="text-slate-400 font-bold text-[10px] uppercase tracking-widest">–†—ñ–≤–µ–Ω—å <span id="user-level">1</span></span>
                    </div>
                </div>
                <div class="flex flex-col items-center sm:items-end gap-2">
                    <button onclick="window.toggleLang()" class="bg-slate-100 px-3 py-1 rounded-full text-[10px] font-black text-slate-500 border border-slate-200">UA / EN</button>
                    <div id="balance-container" class="bg-yellow-100 px-5 py-2 rounded-2xl flex items-center gap-2 border-b-4 border-yellow-200 text-2xl font-black text-yellow-700">‚≠ê <span id="balance">0</span></div>
                </div>
            </div>
            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div id="level-progress" class="progress-bar bg-blue-500 h-full" style="width: 0%"></div></div>
        </header>

        <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar text-xs font-black uppercase tracking-tighter">
            <button onclick="window.switchTab('tasks')" id="tab-tasks" class="flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-blue-600 text-white shadow-md">üéØ –ö–≤–µ—Å—Ç–∏</button>
            <button onclick="window.switchTab('shop')" id="tab-shop" class="flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-white text-slate-600 border border-slate-200">üéÅ –ö—Ä–∞–º–Ω–∏—Ü—è</button>
            <button onclick="window.switchTab('goals')" id="tab-goals" class="flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-white text-slate-600 border border-slate-200">üíé –ú—Ä—ñ—ó</button>
            <button onclick="window.switchTab('calendar')" id="tab-calendar" class="flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-white text-slate-600 border border-slate-200">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä</button>
        </div>

        <div id="section-tasks" class="space-y-4"><div id="tasks-list" class="space-y-3"></div></div>
        <div id="section-shop" class="hidden space-y-4"><div id="shop-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
        <div id="section-goals" class="hidden space-y-4"><div id="goals-list" class="space-y-4"></div></div>
        <div id="section-calendar" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-4"><h3 id="calendar-month-year" class="font-bold uppercase text-sm tracking-widest text-slate-800"></h3><div class="flex gap-2"><button onclick="window.changeMonth(-1)" class="p-2 bg-slate-100 rounded-lg text-slate-600">‚óÄ</button><button onclick="window.changeMonth(1)" class="p-2 bg-slate-100 rounded-lg text-slate-600">‚ñ∂</button></div></div>
                <div class="calendar-grid mb-4" id="calendar-body"></div>
            </div>
            <div id="day-details" class="p-6 bg-white rounded-3xl border border-slate-100 shadow-sm hidden">
                <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-50"><h4 id="details-date" class="font-black text-slate-700 text-xs uppercase tracking-tighter"></h4><div class="bg-blue-600 text-white px-3 py-1 rounded-full text-[9px] font-black">–ó–∞–ª–∏—à–æ–∫: <span id="day-end-balance">0</span> ‚≠ê</div></div>
                <div id="details-logs" class="space-y-2"></div>
            </div>
        </div>

        <footer class="mt-12 py-8 border-t border-slate-200 text-center"><button onclick="window.openPinPad()" class="text-slate-400 text-[10px] font-black uppercase tracking-widest hover:text-slate-600 transition-colors">‚öôÔ∏è –ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</button></footer>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∏ -->
    <div id="pin-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md hidden flex items-center justify-center p-4 z-[400] text-center"><div class="w-full max-w-xs"><h2 class="text-white text-xl font-bold mb-6">–í–≤–µ–¥—ñ—Ç—å PIN</h2><div id="pin-dots" class="flex justify-center gap-4 mb-8 text-center"><div class="w-4 h-4 rounded-full bg-slate-700 transition-all"></div><div class="w-4 h-4 rounded-full bg-slate-700 transition-all"></div><div class="w-4 h-4 rounded-full bg-slate-700 transition-all"></div><div class="w-4 h-4 rounded-full bg-slate-700 transition-all"></div></div><div id="pin-grid" class="grid grid-cols-3 gap-3"></div></div></div>

    <div id="admin-modal" class="fixed inset-0 bg-slate-50 hidden z-[500] overflow-y-auto"><div class="p-6 max-w-2xl mx-auto"><div class="flex justify-between items-center mb-8"><h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è üîê</h2><button onclick="window.closeAdminModal()" class="bg-blue-600 text-white px-6 py-2 rounded-2xl font-bold shadow-lg">–í–∏–π—Ç–∏</button></div><div class="flex gap-2 mb-6 bg-slate-200 p-1 rounded-2xl overflow-x-auto no-scrollbar"><button onclick="window.switchAdminTab('general')" id="admin-tab-general" class="admin-tab-btn active flex-1 py-2 rounded-xl text-[10px] font-black uppercase px-4">–ì–æ–ª–æ–≤–Ω–µ</button><button onclick="window.switchAdminTab('tasks')" id="admin-tab-tasks" class="admin-tab-btn flex-1 py-2 rounded-xl text-[10px] font-black uppercase px-4">–ö–≤–µ—Å—Ç–∏</button><button onclick="window.switchAdminTab('shop')" id="admin-tab-shop" class="admin-tab-btn flex-1 py-2 rounded-xl text-[10px] font-black uppercase px-4">–ö—Ä–∞–º–Ω–∏—Ü—è</button><button onclick="window.switchAdminTab('goals')" id="admin-tab-goals" class="admin-tab-btn flex-1 py-2 rounded-xl text-[10px] font-black uppercase px-4">–ú—Ä—ñ—ó</button><button onclick="window.switchAdminTab('ranks')" id="admin-tab-ranks" class="admin-tab-btn flex-1 py-2 rounded-xl text-[10px] font-black uppercase px-4">–†—ñ–≤–Ω—ñ</button></div><div id="admin-content-general" class="space-y-4 text-center"><button onclick="window.confirmAction('resetTasks')" id="btn-reset-tasks" class="w-full py-4 bg-white border border-slate-200 rounded-3xl font-bold text-slate-700">–°–∫–∏–Ω—É—Ç–∏ –∫–≤–µ—Å—Ç–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</button><button onclick="window.addBonus(50)" class="w-full py-4 bg-yellow-100 rounded-3xl font-bold text-yellow-700">–ë–æ–Ω—É—Å +50 ‚≠ê</button><button onclick="window.runSmokeTests()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px]">üöÄ Smoke Test</button></div><div id="admin-content-tasks" class="hidden space-y-4"><div class="bg-blue-600 p-5 rounded-3xl text-white shadow-xl text-center"><input type="text" id="task-title-ua" placeholder="–ù–∞–∑–≤–∞ (UA)" class="w-full p-3 rounded-xl mb-2 text-slate-800 font-bold"><input type="number" id="task-points" placeholder="–ë–∞–ª–∏" class="w-full p-3 rounded-xl text-slate-800 font-bold mb-2"><input type="text" id="task-icon" placeholder="Emoji" class="w-full p-3 rounded-xl text-slate-800 font-bold text-center mb-4"><button onclick="window.addItem('tasks')" class="w-full bg-white text-blue-600 py-3 rounded-xl font-black uppercase text-xs">–î–æ–¥–∞—Ç–∏</button></div><div id="admin-list-tasks" class="space-y-2"></div></div><div id="admin-content-shop" class="hidden space-y-4"><div class="bg-orange-500 p-5 rounded-3xl text-white shadow-xl text-center"><input type="text" id="shop-title-ua" placeholder="–ù–∞–∑–≤–∞ (UA)" class="w-full p-3 rounded-xl mb-2 text-slate-800 font-bold"><input type="number" id="shop-cost" placeholder="–í–∞—Ä—Ç—ñ—Å—Ç—å ‚≠ê" class="w-full p-3 rounded-xl text-slate-800 font-bold mb-2"><input type="text" id="shop-icon" placeholder="Emoji" class="w-full p-3 rounded-xl text-slate-800 font-bold text-center mb-4"><button onclick="window.addItem('shop')" class="w-full bg-white text-orange-600 py-3 rounded-xl font-black uppercase text-xs">–î–æ–¥–∞—Ç–∏</button></div><div id="admin-list-shop" class="space-y-2"></div></div><div id="admin-content-goals" class="hidden space-y-4"><div class="bg-purple-600 p-5 rounded-3xl text-white shadow-xl text-center"><input type="text" id="goal-title-ua" placeholder="–ù–∞–∑–≤–∞ (UA)" class="w-full p-3 rounded-xl mb-2 text-slate-800 font-bold"><input type="number" id="goal-cost" placeholder="–¶—ñ–ª—å ‚≠ê" class="w-full p-3 rounded-xl text-slate-800 font-bold mb-2"><input type="text" id="goal-icon" placeholder="Emoji" class="w-full p-3 rounded-xl text-slate-800 font-bold text-center mb-4"><button onclick="window.addItem('goals')" class="w-full bg-white text-purple-600 py-3 rounded-xl font-black uppercase text-xs">–î–æ–¥–∞—Ç–∏</button></div><div id="admin-list-goals" class="space-y-2"></div></div><div id="admin-content-ranks" class="hidden space-y-4"><div class="bg-slate-800 p-5 rounded-3xl text-white shadow-xl"><div id="admin-ranks-inputs" class="space-y-4 mb-4"></div><button onclick="window.saveRanks()" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-black uppercase text-xs">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä—ñ–≤–Ω—ñ</button></div></div></div></div>

    <!-- Smoke Test UI -->
    <div id="test-overlay" class="fixed inset-0 bg-slate-900/90 z-[1000] hidden items-center justify-center p-4">
        <div id="test-report" class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6 border-b pb-4 shrink-0"><h3 class="text-xl font-black text-slate-800 uppercase tracking-tighter text-sm">Smoke Test Status üìã</h3><button onclick="document.getElementById('test-overlay').classList.add('hidden')" class="text-slate-400 font-bold p-2">‚úï</button></div>
            <div id="test-steps" class="space-y-3 mb-6 overflow-y-auto flex-1 pr-2 custom-scroll"></div>
            <button onclick="document.getElementById('test-overlay').classList.add('hidden')" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black uppercase text-[10px] tracking-widest shrink-0">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-full font-bold shadow-2xl opacity-0 transition-all pointer-events-none z-[600] text-sm text-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXefvcIw-hwiDIJy16870aqUYII0KN6q0",
            authDomain: "markquestss.firebaseapp.com",
            projectId: "markquestss",
            storageBucket: "markquestss.firebasestorage.app",
            messagingSenderId: "304585921289",
            appId: "1:304585921289:web:e9d633d19b39699b66f9d8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mark-quest-prod-ss-final';

        let state = { balance: 0, totalEarned: 0, completedTasks: [], lang: 'uk', pin: '0000' };
        let config = { tasks: [], shop: [], goals: [], ranks: [] };
        let historyLogs = [];
        let user = null;
        let viewDate = new Date();
        let selectedDateStr = "";
        let deleteConfirmId = null;

        const toYMD = (d) => { const date = new Date(d); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; };
        const translations = { uk: { greeting: "–ú–∞—Ä–∫, –≤–ø–µ—Ä–µ–¥! üöÄ", tasks: "üéØ –ö–≤–µ—Å—Ç–∏", shop: "üéÅ –ö—Ä–∞–º–Ω–∏—Ü—è", goals: "üíé –ú—Ä—ñ—ó", calendar: "üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä", done: "‚úÖ –ì–æ—Ç–æ–≤–æ", buy: "‚≠ê –ö–£–ü–ò–¢–ò", history_empty: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–µ–º–∞—î", confirm_delete: "–¢–æ—á–Ω–æ?" }, en: { greeting: "Go Mark! üöÄ", tasks: "üéØ Quests", shop: "üéÅ Shop", goals: "üíé Dreams", calendar: "üìÖ Calendar", done: "‚úÖ Done", buy: "‚≠ê BUY", history_empty: "No activity", confirm_delete: "Sure?" } };

        const init = async () => {
            selectedDateStr = toYMD(new Date());
            try { await signInAnonymously(auth); } catch (e) { console.error("Auth error:", e); }
            onAuthStateChanged(auth, (u) => { user = u; if (u) setupListeners(); });
            renderPinButtons();
        };

        const setupListeners = () => {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), (snap) => { if (snap.exists()) state = snap.data(); else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), state); updateUI(); document.getElementById('loading').style.display = 'none'; });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'config'), (snap) => { 
                if (snap.exists()) config = snap.data(); 
                else { 
                    const def = { 
                        tasks: [{id: 1, title: {uk: "–ß–∏—â–µ–Ω–Ω—è –∑—É–±—ñ–≤ ü¶∑", en: "Teeth ü¶∑"}, points: 10, icon: "‚ú®"}, {id: 2, title: {uk: "–î–æ–ø–æ–º–æ–≥–∞ –∑ –ø–æ—Å—É–¥–æ–º üçΩÔ∏è", en: "Dishwasher Duty üçΩÔ∏è"}, points: 20, icon: "üßº"}],
                        shop: [{id: 101, title: {uk: "iPad 30 —Ö–≤", en: "iPad 30m"}, cost: 50, icon: "üéÆ"}],
                        goals: [{id: 501, title: {uk: "–í–µ–ª–∏–∫–µ LEGO", en: "LEGO"}, cost: 2000, icon: "üß±"}],
                        ranks: [{threshold:0, title:{uk:"–ù–æ–≤–∞—á–æ–∫", en:"Novice"}}, {threshold:500, title:{uk:"–£—á–µ–Ω—å", en:"Apprentice"}}, {threshold:1500, title:{uk:"–®—É–∫–∞—á", en:"Seeker"}}, {threshold:4000, title:{uk:"–ì–µ—Ä–æ–π", en:"Hero"}}]
                    }; 
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'config'), def); 
                } 
                updateUI(); renderAdminRanks(); 
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snap) => { historyLogs = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderCalendar(); window.showDayDetails(selectedDateStr); });
        };

        const updateUI = () => {
            const t = translations[state.lang];
            document.getElementById('ui-greeting').innerText = t.greeting;
            ['tasks', 'shop', 'goals', 'calendar'].forEach(x => { const el = document.getElementById(`tab-${x}`); if(el) el.innerText = t[x]; });
            document.getElementById('balance').innerText = state.balance;
            updateLevelUI(); renderTasks(); renderShop(); renderGoals(); renderAdminLists();
        };

        const updateLevelUI = () => {
            if (!config.ranks || config.ranks.length === 0) return;
            const total = state.totalEarned || 0;
            let ci = 0; for (let i = config.ranks.length - 1; i >= 0; i--) if (total >= config.ranks[i].threshold) { ci = i; break; }
            document.getElementById('user-rank').innerText = config.ranks[ci].title[state.lang];
            document.getElementById('user-level').innerText = ci + 1;
            const next = config.ranks[ci + 1];
            const p = next ? Math.min(100, Math.max(0, ((total - config.ranks[ci].threshold) / (next.threshold - config.ranks[ci].threshold)) * 100)) : 100;
            document.getElementById('level-progress').style.width = p + "%";
        };

        window.switchTab = (tab) => { ['tasks', 'shop', 'goals', 'calendar'].forEach(t => { document.getElementById(`section-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).className = "flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-white text-slate-600 border border-slate-200 text-xs uppercase"; }); document.getElementById(`section-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).className = "flex-1 min-w-[90px] py-3 rounded-2xl font-bold transition-all bg-blue-600 text-white shadow-md text-xs uppercase"; };
        window.toggleLang = async () => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { lang: state.lang === 'uk' ? 'en' : 'uk' });
        
        window.completeTask = async (id, pts) => { 
            const task = config.tasks.find(t => t.id === id); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { balance: state.balance + pts, totalEarned: (state.totalEarned || 0) + pts, completedTasks: [...state.completedTasks, id] }); 
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { timestamp: Date.now(), type: 'task', title: task.title[state.lang], value: pts, icon: task.icon || 'üéØ' }); 
            showToast(`+${pts} ‚≠ê`); 
        };
        
        window.buyReward = async (id, cost) => { 
            const reward = config.shop.find(r => r.id === id); 
            if(state.balance < cost) return; 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { balance: state.balance - cost }); 
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { timestamp: Date.now(), type: 'reward', title: reward.title[state.lang], value: cost, icon: reward.icon || 'üéÅ' }); 
            showToast(`üéÅ –ö—É–ø–ª–µ–Ω–æ!`); 
        };
        
        window.addItem = async (type) => { 
            const pfx = (type === 'shop') ? 'shop' : type.slice(0, -1); 
            const titleUa = document.getElementById(`${pfx}-title-ua`).value; 
            const val = parseInt(document.getElementById(`${pfx}-${type === 'tasks' ? 'points' : 'cost'}`).value); 
            const icon = document.getElementById(`${pfx}-icon`).value;
            if (!titleUa || isNaN(val)) return showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –±–∞–ª–∏!"); 
            config[type].push({ id: Date.now(), title: { uk: titleUa, en: titleUa }, icon: icon || '‚ú®', [type === 'tasks' ? 'points' : 'cost']: val }); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'config'), config); 
            showToast("–î–æ–¥–∞–Ω–æ!"); 
        };
        
        window.handleDelete = async (type, id) => { 
            if (deleteConfirmId === id) { 
                config[type] = config[type].filter(i => i.id !== id); 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'config'), config); 
                deleteConfirmId = null; 
                showToast("–í–∏–¥–∞–ª–µ–Ω–æ!"); 
            } else { 
                deleteConfirmId = id; renderAdminLists(); 
                setTimeout(() => { if (deleteConfirmId === id) { deleteConfirmId = null; renderAdminLists(); } }, 3000); 
            } 
        };
        
        window.updateRankVal = (i, f, v) => { if (f === 'threshold') config.ranks[i].threshold = parseInt(v); else config.ranks[i].title.uk = v; };
        window.saveRanks = async () => { config.ranks.sort((a,b)=>a.threshold-b.threshold); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'config'), config); showToast("–†—ñ–≤–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!"); };
        
        window.showDayDetails = (ds) => { 
            selectedDateStr = ds; const logs = historyLogs.filter(l => toYMD(l.timestamp) === ds).sort((a,b) => b.timestamp - a.timestamp); 
            const dEl = document.getElementById('details-date'); if(dEl) dEl.innerText = new Date(ds + 'T00:00:00').toLocaleDateString(state.lang==='uk'?'uk-UA':'en-US', {day:'numeric', month:'long'});
            const bEl = document.getElementById('day-end-balance'); if(bEl) bEl.innerText = historyLogs.filter(l => l.timestamp <= new Date(ds + 'T23:59:59').getTime()).reduce((acc,l)=>l.type==='task'?acc+l.value:acc-l.value,0);
            const lEl = document.getElementById('details-logs'); if(!lEl) return;
            if(logs.length===0) lEl.innerHTML = `<p class='text-[10px] text-slate-400 italic py-4 text-center'>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–µ–º–∞—î</p>`;
            else lEl.innerHTML = logs.map(l => `<div class='flex justify-between items-center bg-white p-3 rounded-2xl border border-slate-100 shadow-sm mb-2 text-xs'><div class='flex gap-2 items-center'><span class='text-[8px] text-slate-300'>${new Date(l.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span>${l.icon||'üéØ'}</span><span class='font-bold text-slate-700'>${l.title}</span></div><span class='font-black ${l.type==='task'?'text-green-500':'text-orange-500'}'>${l.type==='task'?'+':'-'}${l.value} ‚≠ê</span></div>`).join('');
            document.getElementById('day-details').classList.remove('hidden'); renderCalendar();
        };

        const renderTasks = () => { const l = document.getElementById('tasks-list'); if(!l) return; l.innerHTML = config.tasks.map(t => `<div class='quest-card bg-white p-5 rounded-3xl flex items-center justify-between shadow-sm border border-slate-100'><div class='flex items-center gap-4'><div class='w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-2xl'>${t.icon}</div><div><h3 class='font-bold text-slate-800 ${state.completedTasks.includes(t.id)?'line-through text-slate-400':''}'>${t.title[state.lang]}</h3><p class='text-[10px] text-slate-400 font-black uppercase'>+${t.points} ‚≠ê</p></div></div><button onclick='window.completeTask(${t.id},${t.points})' ${state.completedTasks.includes(t.id)?'disabled':''} class='px-5 py-3 rounded-2xl font-black text-xs transition-all ${state.completedTasks.includes(t.id)?'bg-slate-50 text-slate-300':'bg-blue-100 text-blue-600 active:bg-blue-600 active:text-white'}'>${state.completedTasks.includes(t.id)?translations[state.lang].done:`+${t.points} ‚≠ê`}</button></div>`).join(''); };
        const renderShop = () => { const l = document.getElementById('shop-list'); if(!l) return; l.innerHTML = config.shop.map(i => `<div class='quest-card bg-white p-5 rounded-3xl flex flex-col gap-4 shadow-sm border border-slate-100'><div class='flex items-center gap-3'><div class='w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-xl'>${i.icon}</div><h3 class='font-bold text-slate-800 text-sm'>${i.title[state.lang]}</h3></div><button onclick='window.buyReward(${i.id},${i.cost})' ${state.balance < i.cost?'disabled':''} class='w-full py-3 rounded-2xl font-black text-xs transition-all ${state.balance >= i.cost?'bg-yellow-400 text-yellow-900 shadow-md':'bg-slate-50 text-slate-300'}'>${i.cost} ${translations[state.lang].buy}</button></div>`).join(''); };
        const renderGoals = () => { const l = document.getElementById('goals-list'); if(!l) return; l.innerHTML = config.goals.map(g => { const p = Math.min(100, Math.floor((state.balance/g.cost)*100)); return `<div class='bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-3'><div class='flex justify-between items-center'><div class='flex items-center gap-3'><span class='text-3xl'>${g.icon}</span><span class='font-bold text-slate-800 text-sm'>${g.title[state.lang]}</span></div><span class='text-blue-600 font-black text-xs'>${p}%</span></div><div class='w-full bg-slate-100 h-3 rounded-full overflow-hidden'><div class='bg-blue-500 h-full transition-all duration-1000' style='width: ${p}%'></div></div><div class='flex justify-between text-[8px] font-black text-slate-400 uppercase'><span>–ë–∞–ª–∞–Ω—Å: ${state.balance} ‚≠ê</span><span>–¶—ñ–ª—å: ${g.cost} ‚≠ê</span></div></div>`; }).join(''); };
        const renderCalendar = () => { const b = document.getElementById('calendar-body'); const mh = document.getElementById('calendar-month-year'); if(!b || !mh) return; const y = viewDate.getFullYear(), m = viewDate.getMonth(); mh.innerText = viewDate.toLocaleDateString(state.lang==='uk'?'uk-UA':'en-US', {month:'long', year:'numeric'}); const fd = new Date(y, m, 1).getDay(); const dim = new Date(y, m+1, 0).getDate(); const off = fd === 0 ? 6 : fd - 1; let h = ""; for (let i = 0; i < off; i++) h += `<div></div>`; for (let d = 1; d <= dim; d++) { const ds = toYMD(new Date(y, m, d)); const earned = historyLogs.filter(l => toYMD(l.timestamp) === ds && l.type === 'task').reduce((s,l)=>s+l.value,0); const bal = historyLogs.filter(l => l.timestamp <= new Date(ds + 'T23:59:59').getTime()).reduce((acc,l)=>l.type==='task'?acc+l.value:acc-l.value,0); h += `<div onclick="window.showDayDetails('${ds}')" class='calendar-day cursor-pointer transition-all ${selectedDateStr===ds?'selected shadow-inner':'bg-slate-100 active:bg-slate-200'}'><span class='${selectedDateStr===ds?'text-blue-600':'text-slate-400'} text-[9px]'>${d}</span>${earned > 0 ? `<span class='text-green-600 text-[6px] font-black'>+${earned}</span>` : ''}${historyLogs.some(l=>toYMD(l.timestamp)===ds) ? `<span class='text-blue-500 text-[6px] font-black'>ü™ô ${bal}</span>` : ''}</div>`; } b.innerHTML = h; };
        const renderAdminLists = () => { ['tasks', 'shop', 'goals'].forEach(type => { const list = document.getElementById(`admin-list-${type}`); if (!list) return; list.innerHTML = config[type].map(i => `<div class='flex items-center justify-between bg-white p-4 rounded-2xl border border-slate-100 shadow-sm mb-2 text-xs'><div class='flex items-center gap-3'><span>${i.icon}</span><p class='font-bold text-slate-800'>${i.title.uk}</p></div><button onclick="window.handleDelete('${type}',${i.id})" class='px-3 py-1 rounded-xl font-black uppercase text-[9px] ${deleteConfirmId===i.id?'bg-red-500 text-white':'bg-slate-50 text-red-400'}'>${deleteConfirmId===i.id?translations[state.lang].confirm_delete:'üóëÔ∏è'}</button></div>`).join(''); }); };
        const renderAdminRanks = () => { const c = document.getElementById('admin-ranks-inputs'); if(!c || !config.ranks) return; c.innerHTML = config.ranks.map((r, i) => `<div class='p-4 bg-slate-700/50 rounded-2xl border border-slate-600 space-y-2'><div class='flex justify-between items-center mb-1 text-white font-bold'><span class='text-[10px] uppercase opacity-50'>–†–∞–Ω–≥ ${i+1}</span><input type='number' value='${r.threshold}' onchange="window.updateRankVal(${i},'threshold',this.value)" class='w-20 bg-slate-900 p-1 rounded-lg text-xs'></div><input type='text' value='${r.title.uk}' onchange="window.updateRankVal(${i},'uk',this.value)" class='w-full bg-slate-900 text-white p-2 rounded-lg text-xs'></div>`).join(''); };

        window.runSmokeTests = async () => {
            const overlay = document.getElementById('test-overlay'); const stepsEl = document.getElementById('test-steps'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); stepsEl.innerHTML = "";
            const testSteps = [{id:"db",name:"DB Connection",status:"WAITING"},{id:"user",name:"User Context",status:"WAITING"},{id:"config",name:"Config Integrity",status:"WAITING"},{id:"task",name:"Task Engine",status:"WAITING"},{id:"levels",name:"Leveling Logic",status:"WAITING"},{id:"lang",name:"Lang Toggle",status:"WAITING"}];
            const renderSteps = () => { stepsEl.innerHTML = testSteps.map(s => { const c = s.status==='PASSED'?'text-green-500':(s.status==='RUNNING'?'text-blue-500':(s.status==='FAILED'?'text-red-500':'text-slate-300')); return `<div class='flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100'><span class='text-[10px] font-black text-slate-800 uppercase'>${s.name}</span><span class='${c} font-black text-[10px]'>${s.status}</span></div>`; }).join(''); };
            const setS = (id, st) => { const s = testSteps.find(x => x.id === id); if(s) s.status = st; renderSteps(); };
            try { setS("db", "RUNNING"); await new Promise(r=>setTimeout(r,500)); setS("db", "PASSED"); setS("user", "RUNNING"); if(user) setS("user", "PASSED"); else throw 1; setS("config", "RUNNING"); if(config.tasks.length > 0) setS("config", "PASSED"); else throw 1; setS("task", "RUNNING"); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { timestamp: Date.now(), type: 'task', title: "Smoke Check", value: 0, icon: 'üß™' }); setS("task", "PASSED"); setS("levels", "RUNNING"); setS("levels", "PASSED"); setS("lang", "RUNNING"); await window.toggleLang(); await new Promise(r=>setTimeout(r,500)); setS("lang", "PASSED"); await window.toggleLang(); } catch(e) { const r = testSteps.find(s=>s.status==='RUNNING'); if(r) setS(r.id, "FAILED"); }
        };

        window.openPinPad = () => { pinB = ""; updatePinDots(); document.getElementById('pin-modal').classList.remove('hidden'); };
        window.closeAdminModal = () => document.getElementById('admin-modal').classList.add('hidden');
        window.closePinPad = () => document.getElementById('pin-modal').classList.add('hidden');
        window.switchAdminTab = (t) => { document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`admin-tab-${t}`).classList.add('active'); ['general', 'tasks', 'shop', 'goals', 'ranks'].forEach(x => document.getElementById(`admin-content-${x}`).classList.add('hidden')); document.getElementById(`admin-content-${t}`).classList.remove('hidden'); deleteConfirmId = null; renderAdminLists(); };
        window.changeMonth = (d) => { viewDate.setMonth(viewDate.getMonth() + d); renderCalendar(); };
        window.updatePin = async () => { const v = document.getElementById('new-pin-input').value; if(v.length === 4) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { pin: v }); showToast("PIN –æ–Ω–æ–≤–ª–µ–Ω–æ!"); } };
        window.addBonus = async (p) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { balance: state.balance + p, totalEarned: (state.totalEarned||0)+p }); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { timestamp: Date.now(), type: 'task', title: "–ë–æ–Ω—É—Å ‚≠ê", value: p, icon: 'üéÅ' }); };
        window.confirmAction = async (a) => { if (a === 'resetTasks') { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'state', 'userState'), { completedTasks: [] }); showToast("–°–∫–∏–Ω—É—Ç–æ"); } };

        let pinB = "";
        window.enterDigit = (d) => { pinB += d; updatePinDots(); if (pinB.length === 4) { if (pinB === state.pin) { pinB = ""; closePinPad(); document.getElementById('admin-modal').classList.remove('hidden'); window.switchAdminTab('general'); } else { pinB = ""; updatePinDots(true); showToast("‚ùå –ü–æ–º–∏–ª–∫–∞"); } } };
        const updatePinDots = (e=false) => { const dots = document.getElementById('pin-dots').children; for(let i=0; i<4; i++) if (dots[i]) dots[i].className = e ? "w-4 h-4 rounded-full bg-red-500" : (i<pinB.length ? "w-4 h-4 rounded-full bg-blue-500 scale-125" : "w-4 h-4 rounded-full bg-slate-700"); };
        const renderPinButtons = () => { const g = document.getElementById('pin-grid'); if(!g) return; let h = ""; for(let i=1; i<=9; i++) h += `<button onclick="window.enterDigit(${i})" class='bg-white/10 text-white rounded-2xl py-4 font-black text-xl active:bg-white/30'>${i}</button>`; h += `<button onclick="pinB='';updatePinDots();" class='bg-red-500/20 text-red-400 rounded-2xl py-4 font-bold'>C</button><button onclick="window.enterDigit(0)" class='bg-white/10 text-white rounded-2xl py-4 font-black text-xl'>0</button><button onclick="window.closePinPad()" class='bg-white/10 text-white rounded-2xl py-4 font-bold text-xl'>‚úï</button>`; g.innerHTML = h; };

        function showToast(m) { const t = document.getElementById('toast'); if(!t) return; t.innerText = m; t.style.opacity = '1'; t.style.bottom = '3rem'; setTimeout(() => { t.style.opacity = '0'; t.style.bottom = '2rem'; }, 2500); }
        init();
    </script>
</body>
</html>